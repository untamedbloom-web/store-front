---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

// Get all posts and sort by date
const posts = (await getCollection("posts")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Prepare posts with their rendered content for the modal
const postsWithContent = await Promise.all(
    posts.map(async (post) => {
        const { Content } = await post.render();
        return { ...post, Content };
    }),
);

const featuredPost = postsWithContent[0];
const otherPosts = postsWithContent.slice(1);

const title = "Journal | Untamed Blooms";
const description =
    "Floral inspiration, workshop updates, and stories from the studio.";
---

<Layout title={title}>
    <Header slot="header" />

    <main>
        <!-- Standardized Page Header -->
        <section class="page-header section-padding fade-in-up">
            <div class="container text-center">
                <!-- <span class="subtitle font-heading">Our Stories</span> -->
                <h1>The Journal</h1>
                <p class="description font-heading">{description}</p>
            </div>
        </section>

        <!-- Featured Post Section -->
        {
            featuredPost && (
                <section class="featured-section container fade-in-up">
                    <div class="featured-card-wrapper">
                        <div class="section-label">Latest Entry</div>
                        <a
                            href={`/blog/${featuredPost.slug}`}
                            class="featured-card trigger-modal"
                            data-index="0"
                            onclick="return false;"
                        >
                            <div class="featured-image-wrapper">
                                {featuredPost.data.image && (
                                    <Image
                                        src={featuredPost.data.image}
                                        alt={featuredPost.data.title}
                                        class="featured-image"
                                    />
                                )}
                            </div>
                            <div class="featured-content">
                                <div class="featured-date">
                                    {featuredPost.data.pubDate.toLocaleDateString(
                                        "en-us",
                                        {
                                            month: "long",
                                            day: "numeric",
                                            year: "numeric",
                                        },
                                    )}
                                </div>
                                <h2>{featuredPost.data.title}</h2>
                                <p>{featuredPost.data.description}</p>
                                <button class="read-more-btn">
                                    Read Story
                                </button>
                            </div>
                        </a>
                    </div>
                </section>
            )
        }

        <!-- Blog Grid -->
        {
            otherPosts.length > 0 && (
                <section class="blog-grid section-padding container">
                    <div class="grid">
                        {otherPosts.map((post, index) => (
                            <article
                                class="modern-card trigger-modal fade-in-up"
                                data-index={index + 1}
                            >
                                <a
                                    href={`/blog/${post.slug}`}
                                    class="card-link"
                                    onclick="return false;"
                                >
                                    <div class="card-image">
                                        {post.data.image && (
                                            <Image
                                                src={post.data.image}
                                                alt={post.data.title}
                                                class="cover-image"
                                            />
                                        )}
                                    </div>
                                    <div class="card-content">
                                        <div class="card-date">
                                            <time
                                                datetime={post.data.pubDate.toISOString()}
                                            >
                                                {post.data.pubDate.toLocaleDateString(
                                                    "en-us",
                                                    {
                                                        month: "short",
                                                        day: "numeric",
                                                        year: "numeric",
                                                    },
                                                )}
                                            </time>
                                        </div>
                                        <h3>{post.data.title}</h3>
                                        <span class="read-link">Read</span>
                                    </div>
                                </a>
                            </article>
                        ))}
                    </div>
                </section>
            )
        }

        <!-- Hidden Content Container (Source of Truth) -->
        <div id="hidden-posts-content" style="display: none;">
            {
                postsWithContent.map((post, index) => (
                    <div id={`post-content-${index}`} class="post-data">
                        <div class="modal-header-content">
                            <span class="modal-date">
                                {post.data.pubDate.toLocaleDateString("en-us", {
                                    month: "long",
                                    day: "numeric",
                                    year: "numeric",
                                })}
                            </span>
                            <h2>{post.data.title}</h2>
                            <span class="modal-author">
                                by {post.data.author}
                            </span>
                        </div>
                        <div class="modal-image-content">
                            {post.data.image && (
                                <Image
                                    src={post.data.image}
                                    alt={post.data.title}
                                    class="modal-hero-image"
                                />
                            )}
                        </div>
                        <div class="modal-body-content">
                            <post.Content />
                        </div>
                    </div>
                ))
            }
        </div>

        <!-- The Modal -->
        <div id="blog-modal" class="modal-overlay" aria-hidden="true">
            <button
                id="modal-prev"
                class="modal-nav prev"
                aria-label="Previous post"
            >
                &larr;
            </button>

            <div class="modal-container">
                <div class="modal-box" id="modal-box">
                    <button
                        id="modal-close"
                        class="modal-close"
                        aria-label="Close modal">&times;</button
                    >
                    <div class="modal-scroll-content" id="modal-scroll-content">
                        <!-- Content injected here via JS -->
                        <div
                            id="modal-dynamic-content"
                            class="modal-dynamic-content"
                        >
                        </div>
                    </div>
                </div>
            </div>

            <button
                id="modal-next"
                class="modal-nav next"
                aria-label="Next post"
            >
                &rarr;
            </button>
        </div>
    </main>

    <Footer slot="footer" />
</Layout>

<script>
    function initModal() {
        const modal = document.getElementById("blog-modal");
        const modalContent = document.getElementById("modal-dynamic-content");
        const triggers = document.querySelectorAll(
            ".trigger-modal, .card-link",
        ); // Capture both container and link
        const closeBtn = document.getElementById("modal-close");
        const prevBtn = document.getElementById("modal-prev");
        const nextBtn = document.getElementById("modal-next");
        const scrollContainer = document.getElementById("modal-scroll-content");

        let currentIndex = 0;
        const totalPosts = document.querySelectorAll(".post-data").length;

        function loadPost(index) {
            if (index < 0) index = totalPosts - 1;
            if (index >= totalPosts) index = 0;

            currentIndex = index;

            const sourceContent = document.getElementById(
                `post-content-${index}`,
            );
            if (sourceContent && modalContent) {
                modalContent.innerHTML = sourceContent.innerHTML;
            }

            if (scrollContainer) scrollContainer.scrollTop = 0;
        }

        function openModal(index) {
            loadPost(index);
            if (modal) {
                modal.setAttribute("aria-hidden", "false");
                modal.classList.add("open");
                document.body.style.overflow = "hidden";
            }
        }

        function closeModal() {
            if (modal) {
                modal.setAttribute("aria-hidden", "true");
                modal.classList.remove("open");
                document.body.style.overflow = "";
            }
        }

        triggers.forEach((trigger) => {
            trigger.addEventListener("click", (e) => {
                e.preventDefault(); // Critical: prevent navigation
                e.stopPropagation();

                // Find the closest element with data-index
                // @ts-ignore
                const wrapper = trigger.closest(".trigger-modal");
                if (wrapper) {
                    const indexStr = wrapper.getAttribute("data-index");
                    if (indexStr) {
                        const index = parseInt(indexStr);
                        openModal(index);
                    }
                }
            });
        });

        if (closeBtn) closeBtn.addEventListener("click", closeModal);

        if (prevBtn) {
            prevBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                loadPost(currentIndex - 1);
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                loadPost(currentIndex + 1);
            });
        }

        if (modal) {
            modal.addEventListener("click", (e) => {
                // @ts-ignore
                if (
                    e.target === modal ||
                    // @ts-ignore
                    (e.target.classList.contains("modal-container") &&
                        !e.target.closest(".modal-box") &&
                        !e.target.closest(".modal-nav"))
                ) {
                    closeModal();
                }
            });
        }

        document.addEventListener("keydown", (e) => {
            if (modal && modal.getAttribute("aria-hidden") === "false") {
                if (e.key === "Escape") closeModal();
                if (e.key === "ArrowLeft") loadPost(currentIndex - 1);
                if (e.key === "ArrowRight") loadPost(currentIndex + 1);
            }
        });
    }

    // Initialize on load and after View Transitions (if enabled in future)
    document.addEventListener("DOMContentLoaded", initModal);
</script>

<style>
    /* Standardized Page Header (Matching Contact/Services) */
    .page-header {
        padding-top: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
    }

    .page-header h1 {
        font-family: var(--font-family-script);
        font-size: 3.5rem; /* Increased size for impact, similar to "Get in Touch" */
        color: var(--color-primary);
        line-height: 1;
        margin-bottom: var(--spacing-sm);
        text-align: center;
    }

    .subtitle {
        font-family: var(--font-family-subtitle);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--color-accent);
        display: block;
        margin-bottom: var(--spacing-xs);
    }

    .description {
        font-family: var(--font-family-heading);
        font-size: 1.25rem;
        color: var(--color-text-muted);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    /* Featured Section */
    .featured-section {
        margin-bottom: var(--spacing-xl);
    }

    .section-label {
        font-family: var(--font-family-heading);
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: var(--spacing-md);
        color: var(--color-secondary);
        font-style: italic;
    }

    /* Boxed Featured Card */
    .featured-card {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 0; /* Remove gap for seamless box look */
        align-items: stretch; /* Stretch to fill height */
        text-decoration: none;
        color: inherit;
        cursor: pointer;
        background: white; /* Explicit box background */
        border: 1px solid var(--color-border); /* Box border */
        overflow: hidden; /* Contain children */
        box-shadow: var(--shadow-md); /* Box shadow */
        transition:
            transform 0.3s ease,
            box-shadow 0.3s ease;
        border-radius: var(--radius-lg); /* Softer corners */
    }

    .featured-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .featured-image-wrapper {
        min-height: 500px;
        overflow: hidden;
        border-right: 1px solid var(--color-border); /* Separator */
    }

    .featured-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.7s ease;
    }

    .featured-card:hover .featured-image {
        transform: scale(1.03);
    }

    .featured-content {
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: white;
    }

    .featured-date {
        font-family: var(--font-family-heading);
        color: var(--color-primary);
        font-size: 1.1rem;
        font-weight: bold; /* Highlighted */
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: var(--spacing-sm);
        padding-bottom: var(--spacing-xs);
        border-bottom: 2px solid var(--color-accent); /* Highlight underline */
        display: inline-block;
        width: max-content;
    }

    .featured-content h2 {
        font-family: var(--font-family-heading);
        font-size: 3rem;
        color: var(--color-primary);
        line-height: 1.1;
        margin-bottom: var(--spacing-md);
        font-weight: 400;
        text-align: left;
    }

    .featured-content p {
        font-size: 1.1rem;
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-md);
        line-height: 1.6;
        text-align: left;
    }

    .read-more-btn {
        background: transparent;
        border: 1px solid var(--color-primary);
        color: var(--color-primary);
        padding: 12px 30px;
        font-family: var(--font-family-heading);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        cursor: pointer;
        align-self: flex-start;
        border-radius: 50px;
    }

    .featured-card:hover .read-more-btn {
        background: var(--color-primary);
        color: white;
    }

    /* Grid Section */
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Boxed Modern Cards */
    .modern-card {
        background: white;
        border: 1px solid var(--color-border); /* Visible box border */
        overflow: hidden;
        transition:
            transform 0.3s ease,
            box-shadow 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        border-radius: var(--radius-lg); /* Softer corners */
    }

    .card-link {
        display: flex;
        flex-direction: column;
        height: 100%;
        text-decoration: none;
        color: inherit;
    }

    .modern-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        border-color: var(--color-primary); /* Highlight border on hover */
    }

    .card-image {
        height: 250px;
        overflow: hidden;
        border-bottom: 1px solid var(--color-border);
    }

    .cover-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.7s ease;
    }

    .modern-card:hover .cover-image {
        transform: scale(1.05);
    }

    .card-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        flex-grow: 1;
        background: white;
    }

    .card-date {
        font-family: var(--font-family-heading);
        font-size: 0.85rem;
        color: var(--color-primary); /* Highlighted color */
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        font-weight: 600;
        background: var(--color-surface); /* Subtle pill background for date */
        padding: 4px 12px;
        border-radius: 20px;
    }

    .card-content h3 {
        font-family: var(--font-family-heading);
        font-size: 1.5rem;
        color: var(--color-text-main);
        line-height: 1.3;
        margin-bottom: 1rem;
        font-weight: 400;
    }

    .read-link {
        margin-top: auto;
        font-family: var(--font-family-heading);
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.1em;
        color: var(--color-secondary);
        border-bottom: 1px solid transparent;
        transition: border-color 0.3s;
    }

    .modern-card:hover .read-link {
        border-color: var(--color-secondary);
        color: var(--color-primary);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98); /* Less transparent for focus */
        z-index: 2000; /* High z-index */
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.3s ease,
            visibility 0.3s ease;
    }

    .modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .modal-container {
        position: relative;
        max-width: 900px;
        width: 100%;
        height: auto;
        max-height: 90vh; /* Don't be full height, be a 'box' */
        padding: 20px; /* Space for the close button if it overhangs */
        display: flex;
        flex-direction: column;
    }

    .modal-box {
        background: white;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        left: 20px;
        background: none;
        border: none;
        font-size: 2.5rem; /* Slightly smaller for cleaner look */
        color: var(--color-text-muted); /* Softer color */
        cursor: pointer;
        z-index: 2020;
        line-height: 1;
        padding: 0;
        width: auto;
        height: auto;
        transition: color 0.2s;
    }

    .modal-close:hover {
        color: var(--color-primary);
        background: none;
        border: none;
    }

    .modal-nav {
        background: none;
        border: none;
        font-size: 3rem;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 20px;
        transition:
            transform 0.2s,
            color 0.2s;
        z-index: 2010;
        display: none;
        opacity: 0.6;
    }

    .modal-nav:hover {
        opacity: 1;
        color: var(--color-primary);
        transform: scale(1.1);
    }

    .modal-nav.prev {
        position: fixed;
        left: 30px;
        top: 50%;
        transform: translateY(-50%);
    }

    .modal-nav.next {
        position: fixed;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
    }

    .modal-scroll-content {
        overflow-y: auto;
        padding: 60px 40px 40px 40px; /* Increased top padding to avoid overlap with close button */
        height: 100%;
        scrollbar-width: thin;
        scrollbar-color: var(--color-border) transparent;
    }

    /* Modal Content Styles - Centered & Elegant */
    .modal-dynamic-content {
        padding-bottom: 50px;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Copied Styles for Inner Modal Content */
    .modal-dynamic-content :global(.modal-header-content) {
        text-align: center;
        margin-bottom: 2.5rem;
    }

    .modal-dynamic-content :global(.modal-date) {
        display: inline-block;
        font-family: var(--font-family-heading);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-primary);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--color-accent);
        padding-bottom: 5px;
    }

    .modal-dynamic-content :global(h2) {
        font-family: var(--font-family-heading);
        font-size: 3.5rem;
        color: var(--color-text-main);
        line-height: 1.1;
        margin-bottom: 1rem;
        font-weight: 400;
    }

    .modal-dynamic-content :global(.modal-author) {
        display: block;
        font-family: var(--font-family-heading);
        color: var(--color-text-muted);
        font-style: italic;
    }

    .modal-dynamic-content :global(.modal-image-content) {
        margin-bottom: 3rem;
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }

    .modal-dynamic-content :global(.modal-hero-image) {
        width: 100%;
        height: auto;
        max-height: 60vh;
        object-fit: cover;
        display: block;
    }

    .modal-dynamic-content :global(.modal-body-content) {
        max-width: 65ch;
        margin: 0 auto;
        font-size: 1.2rem; /* Larger reading text */
        line-height: 1.8;
        color: var(--color-text-main);
    }

    .modal-dynamic-content :global(p) {
        margin-bottom: 1.5rem;
    }

    @media (min-width: 769px) {
        .modal-nav {
            display: block;
        }
    }

    @media (max-width: 900px) {
        .featured-card {
            grid-template-columns: 1fr;
        }

        .featured-image-wrapper {
            border-right: none;
            border-bottom: 1px solid var(--color-border);
            min-height: 300px;
        }

        .modal-dynamic-content :global(h2) {
            font-size: 2.5rem;
        }

        .page-header h1 {
            font-size: 4rem;
        }
    }
</style>
